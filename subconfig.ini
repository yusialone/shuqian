/*
powerfullz's Substore Subscription Conversion Script (Customized Version)
https://github.com/powerfullz/override-rules
Incoming parameters:
- loadbalance: Enable load balancing (default false)
- landing: Enable landing node functionality (default false)
- ipv6: Enable IPv6 support (default false)
- full: Enable full configuration for pure kernel startup (default false)
- keepalive: Enable tcp-keep-alive (default false)
- fakeip: Use FakeIP for DNS instead of RedirHost (default false)
*/

const inArg = typeof $arguments !== 'undefined' ? $arguments : {};
const loadBalance = parseBool(inArg.loadbalance) || false,
    landing = parseBool(inArg.landing) || false,
    ipv6Enabled = parseBool(inArg.ipv6) || false,
    fullConfig = parseBool(inArg.full) || false,
    keepAliveEnabled = parseBool(inArg.keepalive) || false,
    fakeIPEnabled = parseBool(inArg.fakeip) || false;

function buildBaseLists({ landing, dedicatedLine, countryInfo }) {
    const countryGroupNames = countryInfo
        .filter(item => item.count > 0) // Create only if nodes exist
        .map(item => item.country + "èŠ‚ç‚¹");
    countryGroupNames.push("æœªçŸ¥èŠ‚ç‚¹"); // Add unknown nodes group

    // defaultSelector (candidates displayed in the selection node group)
    const selector = ["æ•…éšœè½¬ç§»"]; // Put fallback at the beginning
    if (landing) selector.push("è½åœ°èŠ‚ç‚¹");
    selector.push(...countryGroupNames);
    if (dedicatedLine) selector.push("ä¸“çº¿èŠ‚ç‚¹");
    selector.push("æ‰‹åŠ¨é€‰æ‹©", "DIRECT");

    // defaultProxies (referenced by various category policies)
    const defaultProxies = ["é€‰æ‹©èŠ‚ç‚¹", ...countryGroupNames];
    if (dedicatedLine) defaultProxies.push("ä¸“çº¿èŠ‚ç‚¹");
    defaultProxies.push("æ‰‹åŠ¨é€‰æ‹©", "ç›´è¿ž");

    // direct-first list
    const defaultProxiesDirect = ["ç›´è¿ž", ...countryGroupNames, "é€‰æ‹©èŠ‚ç‚¹", "æ‰‹åŠ¨é€‰æ‹©"]; // Direct connection priority
    if (dedicatedLine) {
        defaultProxiesDirect.splice(1 + countryGroupNames.length, 0, "ä¸“çº¿èŠ‚ç‚¹");
    }

    const defaultFallback = [];
    if (landing) defaultFallback.push("è½åœ°èŠ‚ç‚¹");
    defaultFallback.push(...countryGroupNames);
    if (dedicatedLine) defaultFallback.push("ä¸“çº¿èŠ‚ç‚¹");
    defaultFallback.push("æ‰‹åŠ¨é€‰æ‹©", "DIRECT");

    return { defaultProxies, defaultProxiesDirect, defaultSelector: selector, defaultFallback, countryGroupNames };
}


const ruleProviders = {
    "ADBlock": {
        "type": "http", "behavior": "domain", "format": "text", "interval": 86400,
        "url": "https://adrules.top/adrules_domainset.txt",
        "path": "./ruleset/ADBlock.txt"
    },
    "StaticResources": {
        "type": "http", "behavior": "domain", "format": "text", "interval": 86400,
        "url": "https://ruleset.skk.moe/Clash/domainset/cdn.txt",
        "path": "./ruleset/StaticResources.txt"
    },
    "CDNResources": {
        "type": "http", "behavior": "classical", "format": "text", "interval": 86400,
        "url": "https://ruleset.skk.moe/Clash/non_ip/cdn.txt",
        "path": "./ruleset/CDNResources.txt"
    },
    "AI": {
        "type": "http", "behavior": "classical", "format": "text", "interval": 86400,
        "url": "https://ruleset.skk.moe/Clash/non_ip/ai.txt",
        "path": "./ruleset/AI.txt"
    },
    "AdditionalFilter": {
        "type": "http", "behavior": "classical", "format": "text", "interval": 86400,
        "url": "https://cdn.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalFilter.list",
        "path": "./ruleset/AdditionalFilter.list"
    },
    "AdditionalCDNResources": {
        "type": "http", "behavior": "classical", "format": "text", "interval": 86400,
        "url": "https://cdn.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalCDNResources.list",
        "path": "./ruleset/AdditionalCDNResources.list"
    }
}

const rules = [
    "RULE-SET,ADBlock,å¹¿å‘Šæ‹¦æˆª",
    "RULE-SET,AdditionalFilter,å¹¿å‘Šæ‹¦æˆª",
    "RULE-SET,StaticResources,é™æ€èµ„æº",
    "RULE-SET,CDNResources,é™æ€èµ„æº",
    "RULE-SET,AdditionalCDNResources,é™æ€èµ„æº",
    "RULE-SET,AI,AI",
    "DOMAIN-SUFFIX,google.com,Google æœåŠ¡",
    "DOMAIN-SUFFIX,googleapis.com,Google æœåŠ¡",
    "DOMAIN-SUFFIX,gstatic.com,Google æœåŠ¡",
    "GEOSITE,TELEGRAM,Telegram",
    "GEOSITE,YOUTUBE,YouTube",
    "GEOSITE,TWITCH,Twitch",
    "GEOSITE,BILIBILI,Bilibili",
    "DOMAIN-SUFFIX,hltv.org,HLTV",
    "GEOSITE,GITHUB,GitHub",
    "GEOSITE,ONEDRIVE,OneDrive",
    "GEOSITE,GFW,é€‰æ‹©èŠ‚ç‚¹",
    "GEOSITE,CN,ç›´è¿ž",
    "GEOSITE,PRIVATE,ç›´è¿ž",
    "GEOIP,TELEGRAM,Telegram,no-resolve",
    "GEOIP,CN,ç›´è¿ž",
    "GEOIP,PRIVATE,ç›´è¿ž",
    "MATCH,æ¼ç½‘ä¹‹é±¼"
];

const snifferConfig = {
    "sniff": {
        "TLS": { "ports": [443, 8443] },
        "HTTP": { "ports": [80, 8080, 8880] },
        "QUIC": { "ports": [443, 8443] }
    },
    "override-destination": false,
    "enable": true,
    "force-dns-mapping": true,
    "skip-domain": ["Mijia Cloud", "dlg.io.mi.com", "+.push.apple.com"]
};

const dnsConfig = {
    "enable": true,
    "ipv6": ipv6Enabled,
    "prefer-h3": true,
    "enhanced-mode": "redir-host",
    "default-nameserver": ["119.29.29.29", "223.5.5.5"],
    "nameserver": ["system", "223.5.5.5", "119.29.29.29", "180.184.1.1"],
    "fallback": ["quic://dns0.eu", "https://dns.cloudflare.com/dns-query", "https://dns.sb/dns-query", "tcp://208.67.222.222", "tcp://8.26.56.2"],
    "proxy-server-nameserver": ["quic://223.5.5.5", "tls://dot.pub"]
};

const dnsConfig2 = {
    "enable": true,
    "ipv6": ipv6Enabled,
    "prefer-h3": true,
    "enhanced-mode": "fake-ip",
    "fake-ip-filter": ["geosite:private", "geosite:connectivity-check", "geosite:cn", "Mijia Cloud", "dig.io.mi.com", "localhost.ptlogin2.qq.com", "*.icloud.com", "*.stun.*.*", "*.stun.*.*.*"],
    "default-nameserver": ["119.29.29.29", "223.5.5.5"],
    "nameserver": ["system", "223.5.5.5", "119.29.29.29", "180.184.1.1"],
    "fallback": ["quic://dns0.eu", "https://dns.cloudflare.com/dns-query", "https://dns.sb/dns-query", "tcp://208.67.222.222", "tcp://8.26.56.2"],
    "proxy-server-nameserver": ["quic://223.5.5.5", "tls://dot.pub"]
};

const geoxURL = {
    "geoip": "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat",
    "geosite": "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat",
    "mmdb": "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/Country.mmdb",
    "asn": "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-ASN.mmdb"
};

// Regional metadata (for separate grouping)
const countriesMeta = {
    "é¦™æ¸¯": {
        pattern: "(?i)é¦™æ¸¯|æ¸¯|HK|hk|Hong Kong|HongKong|hongkong|ðŸ‡­ðŸ‡°",
        icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Hong_Kong.png"
    },
    "æ–°åŠ å¡": {
        pattern: "(?i)æ–°åŠ å¡|å¡|ç‹®åŸŽ|SG|Singapore|ðŸ‡¸ðŸ‡¬",
        icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Singapore.png"
    },
    "æ—¥æœ¬": {
        pattern: "(?i)æ—¥æœ¬|å·æ—¥|ä¸œäº¬|å¤§é˜ª|æ³‰æ—¥|åŸ¼çŽ‰|æ²ªæ—¥|æ·±æ—¥|JP|Japan|ðŸ‡¯ðŸ‡µ",
        icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Japan.png"
    },
    "ç¾Žå›½": {
        pattern: "(?i)ç¾Žå›½|ç¾Ž|US|United States|ðŸ‡ºðŸ‡¸",
        icon: "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/United_States.png"
    }
};

// Countries to exclude from "unknown nodes"
const excludedCountriesMeta = {
    "æ³•å›½": { pattern: "(?i)æ³•å›½|æ³•|FR|France|ðŸ‡«ðŸ‡·" },
    "è‹±å›½": { pattern: "(?i)è‹±å›½|United Kingdom|UK|ä¼¦æ•¦|London|ðŸ‡¬ðŸ‡§" },
    "åœŸè€³å…¶": { pattern: "(?i)åœŸè€³å…¶|åœŸ|TR|Turkey|ðŸ‡¹ðŸ‡·" },
    "æ³¢å…°": { pattern: "(?i)æ³¢å…°|PL|Poland|ðŸ‡µðŸ‡±" },
    "ä¿„ç½—æ–¯": { pattern: "(?i)ä¿„ç½—æ–¯|ä¿„|RU|Russia|ðŸ‡·ðŸ‡º" },
    "éŸ©å›½": { pattern: "(?i)KR|Korea|KOR|é¦–å°”|éŸ©|éŸ“|ðŸ‡°ðŸ‡·" },
    "å°åº¦": { pattern: "(?i)å°åº¦|IN|India|ðŸ‡®ðŸ‡³" },
    "å¾·å›½": { pattern: "(?i)å¾·å›½|å¾·|DE|Germany|ðŸ‡©ðŸ‡ª" }
};


function parseBool(value) {
    if (typeof value === "boolean") return value;
    if (typeof value === "string") {
        return value.toLowerCase() === "true" || value === "1";
    }
    return false;
}

function hasDedicatedLine(config) {
    // Check for dedicated line nodes
    const proxies = config["proxies"];
    const dedicatedLineRegex = new RegExp(/ä¸“çº¿|IPLC|IEPL/, 'i');
    for (const proxy of proxies) {
        if (dedicatedLineRegex.test(proxy.name)) {
            return true;
        }
    }
    return false;
}

function parseCountries(config) {
    const proxies = config.proxies || [];
    const ispRegex = /å®¶å®½|å®¶åº­|å®¶åº­å®½å¸¦|å•†å®½|å•†ä¸šå®½å¸¦|æ˜Ÿé“¾|Starlink|è½åœ°/i;

    const countryCounts = Object.create(null);
    const compiledRegex = {};
    for (const [country, meta] of Object.entries(countriesMeta)) {
        compiledRegex[country] = new RegExp(meta.pattern.replace(/^\(\?i\)/, ''), 'i');
    }

    for (const proxy of proxies) {
        const name = proxy.name || '';
        if (ispRegex.test(name)) continue;

        let matched = false;
        for (const [country, regex] of Object.entries(compiledRegex)) {
            if (regex.test(name)) {
                countryCounts[country] = (countryCounts[country] || 0) + 1;
                matched = true;
                break;
            }
        }
    }

    const result = [];
    for (const [country, count] of Object.entries(countryCounts)) {
        result.push({ country, count });
    }
    return result;
}


function buildCountryProxyGroups(countryList) {
    const countryProxyGroups = [];

    // Create node groups for existing regions
    for (const country of countryList) {
        if (countriesMeta[country]) {
            const groupName = `${country}èŠ‚ç‚¹`;
            const pattern = countriesMeta[country].pattern;
            const groupConfig = {
                "name": groupName,
                "icon": countriesMeta[country].icon,
                "include-all": true,
                "filter": pattern,
                "exclude-filter": landing ? "(?i)å®¶å®½|å®¶åº­|å®¶åº­å®½å¸¦|å•†å®½|å•†ä¸šå®½å¸¦|æ˜Ÿé“¾|Starlink|è½åœ°|ä¸“çº¿|IPLC|IEPL" : "(?i)ä¸“çº¿|IPLC|IEPL",
                "type": (loadBalance) ? "load-balance" : "url-test",
            };
            if (!loadBalance) {
                Object.assign(groupConfig, {
                    "url": "https://cp.cloudflare.com/generate_204",
                    "interval": 60,
                    "tolerance": 20,
                    "lazy": false
                });
            }
            countryProxyGroups.push(groupConfig);
        }
    }

    // Create unknown nodes group
    const stripCaseInsensitive = (pattern) => pattern.replace(/^\(\?i\)/, '');
    const wantedPatterns = Object.values(countriesMeta).map(meta => stripCaseInsensitive(meta.pattern));
    const excludedPatterns = Object.values(excludedCountriesMeta).map(meta => stripCaseInsensitive(meta.pattern));
    const allExcludedPatterns = [...wantedPatterns, ...excludedPatterns, 'ä¸“çº¿', 'IPLC', 'IEPL'].join('|');

    countryProxyGroups.push({
        "name": "æœªçŸ¥èŠ‚ç‚¹",
        "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Unknown.png",
        "type": (loadBalance) ? "load-balance" : "url-test",
        "include-all": true,
        "exclude-filter": `(?i)(${allExcludedPatterns}|å®¶å®½|å®¶åº­|å®¶åº­å®½å¸¦|å•†å®½|å•†ä¸šå®½å¸¦|æ˜Ÿé“¾|Starlink|è½åœ°)`,
        ...(loadBalance ? {} : {
            "url": "https://cp.cloudflare.com/generate_204",
            "interval": 60,
            "tolerance": 20,
            "lazy": false
        })
    });

    return countryProxyGroups;
}

function buildProxyGroups({
    countryList,
    countryProxyGroups,
    dedicatedLine,
    defaultProxies,
    defaultProxiesDirect,
    defaultSelector,
    defaultFallback
}) {
    // Check if specific region nodes exist
    const hasTW = countryList.includes("å°æ¹¾");
    const hasHK = countryList.includes("é¦™æ¸¯");

    return [
        {
            "name": "é€‰æ‹©èŠ‚ç‚¹",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Proxy.png",
            "type": "select",
            "proxies": defaultSelector
        },
        {
            "name": "æ‰‹åŠ¨é€‰æ‹©",
            "icon": "https://cdn.jsdelivr.net/gh/shindgewongxj/WHATSINStash@master/icon/select.png",
            "include-all": true,
            "type": "select"
        },
        {
            "name": "æ•…éšœè½¬ç§»",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Bypass.png",
            "type": "fallback",
            "url": "https://cp.cloudflare.com/generate_204",
            "proxies": defaultFallback,
            "interval": 180,
            "tolerance": 20,
            "lazy": false
        },
        {
            "name": "é™æ€èµ„æº",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cloudflare.png",
            "type": "select",
            "proxies": defaultProxies,
        },
        {
            "name": "AI",
            "icon": "https://cdn.jsdelivr.net/gh/powerfullz/override-rules@master/icons/chatgpt.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Google æœåŠ¡",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Google.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Telegram",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Telegram.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "YouTube",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/YouTube.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Twitch",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Twitch.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "Bilibili",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/bilibili.png",
            "type": "select",
            "proxies": (hasTW && hasHK) ? ["ç›´è¿ž", "å°æ¹¾èŠ‚ç‚¹", "é¦™æ¸¯èŠ‚ç‚¹"] : defaultProxiesDirect
        },
        {
            "name": "HLTV",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Game.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "GitHub",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/GitHub.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "OneDrive",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/OneDrive.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "æ¼ç½‘ä¹‹é±¼",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Puzzle.png",
            "type": "select",
            "proxies": defaultProxies
        },
        {
            "name": "ç›´è¿ž",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Direct.png",
            "type": "select",
            "proxies": ["DIRECT", "é€‰æ‹©èŠ‚ç‚¹"]
        },
        {
            "name": "å¹¿å‘Šæ‹¦æˆª",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/AdBlack.png",
            "type": "select",
            "proxies": ["REJECT", "ç›´è¿ž"]
        },
        (dedicatedLine) ? {
            "name": "ä¸“çº¿èŠ‚ç‚¹",
            "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Premium.png",
            "type": (loadBalance) ? "load-balance" : "url-test",
            "url": "https://cp.cloudflare.com/generate_204",
            "include-all": true,
            "filter": "(?i)ä¸“çº¿|IPLC|IEPL"
        } : null,
        ...countryProxyGroups
    ].filter(Boolean); // Filter out null values
}


function main(config) {
    config = { proxies: config.proxies };
    const countryInfo = parseCountries(config);
    const dedicatedLine = hasDedicatedLine(config);

    const {
        defaultProxies,
        defaultProxiesDirect,
        defaultSelector,
        defaultFallback,
        countryGroupNames: targetCountryList
    } = buildBaseLists({ landing, dedicatedLine, countryInfo });

    const countryProxyGroups = buildCountryProxyGroups(countryInfo.map(item => item.country));

    const proxyGroups = buildProxyGroups({
        countryList: countryInfo.map(item => item.country),
        countryProxyGroups,
        dedicatedLine,
        defaultProxies,
        defaultProxiesDirect,
        defaultSelector,
        defaultFallback
    });

    const globalProxies = proxyGroups.map(item => item.name);
    proxyGroups.push({
        "name": "GLOBAL",
        "icon": "https://cdn.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png",
        "include-all": true,
        "type": "select",
        "proxies": globalProxies
    });

    if (fullConfig) {
        Object.assign(config, {
            "mixed-port": 7890,
            "redir-port": 7892,
            "tproxy-port": 7893,
            "routing-mark": 7894,
            "allow-lan": true,
            "ipv6": ipv6Enabled,
            "mode": "rule",
            "unified-delay": true,
            "tcp-concurrent": true,
            "find-process-mode": "off",
            "log-level": "info",
            "geodata-loader": "standard",
            "external-controller": ":9999",
            "disable-keep-alive": !keepAliveEnabled,
            "profile": { "store-selected": true }
        });
    }

    Object.assign(config, {
        "proxy-groups": proxyGroups,
        "rule-providers": ruleProviders,
        "rules": rules,
        "sniffer": snifferConfig,
        "dns": fakeIPEnabled ? dnsConfig2 : dnsConfig,
        "geodata-mode": true,
        "geox-url": geoxURL,
    });

    return config;
}
